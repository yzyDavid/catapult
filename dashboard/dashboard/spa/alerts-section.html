<!DOCTYPE html>
<!--
Copyright 2018 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/bower_components/iron-icon/iron-icon.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/bower_components/paper-progress/paper-progress.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="/bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="/dashboard/spa/alerts-table.html">
<link rel="import" href="/dashboard/spa/chart-pair.html">
<link rel="import" href="/dashboard/spa/dropdown-input.html">
<link rel="import" href="/dashboard/spa/element-base.html">
<link rel="import" href="/dashboard/spa/triage-existing.html">
<link rel="import" href="/dashboard/spa/triage-new.html">
<link rel="import" href="/dashboard/static/group_alerts.html">
<link rel="import" href="/tracing/value/legacy_unit_info.html">

<dom-module id="alerts-section">
  <template>
    <style>
      #controls {
        align-items: center;
        display: flex;
        margin-bottom: 8px;
      }

      #sheriff {
        width: 350px;
      }

      #sheriff_container,
      #bug_container,
      #report_container,
      #min_revision,
      #max_revision {
        margin-right: 8px;
      }

      paper-toggle-button {
        display: inline-flex;
      }

      #triaged {
        margin-left: 8px;
        margin-right: 8px;
      }

      #summary {
        flex-grow: 1;
        text-align: center;
      }

      paper-progress {
        --paper-progress-active-color: var(--paper-indigo-500);
        --paper-progress-container-color: white;
        width: 100%;
      }

      chart-pair {
        height: 215px;
        margin-bottom: 8px;
      }

      #recent_bugs {
        border-radius: 24px;
        background-color: var(--paper-indigo-50);
        color: var(--paper-indigo-500);
      }

      #recent_bugs[disabled] {
        background-color: var(--paper-grey-100);
        color: var(--paper-grey-500);
      }

      #recent_bugs_table {
        margin: 0;
        padding: 0;
      }

      paper-dialog {
        margin: 0;
        padding: 8px;
        position: absolute !important;
      }

      #close {
        align-self: flex-start;
        cursor: pointer;
        flex-shrink: 0;
        height: 24px;
        width: 24px;
      }

      #triage_controls {
        align-items: center;
        display: flex;
        padding-left: 24px;
        transition: background-color var(--transition-short), color var(--transition-short);
      }

      #triage_controls[anySelected] {
        background-color: var(--paper-indigo-50);
        color: var(--paper-indigo-500);
      }

      #triage_controls .button {
        background: unset;
        cursor: pointer;
        font-weight: bold;
        padding: 8px;
        text-transform: uppercase;
      }

      #triage_controls .button[disabled] {
        color: var(--paper-grey-500);
        font-weight: normal;
      }

      #selected_alerts_count {
        flex-grow: 1;
      }

      #edit, #documentation {
        color: var(--paper-indigo-500);
        padding: 8px;
      }

      paper-toast a {
        color: var(--paper-indigo-300);
      }
    </style>

    <div id="controls">
      <iron-collapse
          horizontal
          id="sheriff_container"
          opened="[[showSheriff_(bug, report)]]">
        <dropdown-input
            id="sheriff"
            state-path="[[statePath]].sheriff"
            on-clear="onSheriffClear_"
            on-option-select="onSheriffSelect_">
        </dropdown-input>
      </iron-collapse>

      <iron-collapse
          horizontal
          id="bug_container"
          opened="[[showBug_(sheriff, report)]]">
        <dropdown-input
            id="bug"
            state-path="[[statePath]].bug"
            on-clear="onBugClear_"
            on-input-keyup="onBugKeyup_"
            on-option-select="onBugSelect_">
        </dropdown-input>
      </iron-collapse>

      <iron-collapse
          horizontal
          id="report_container"
          opened="[[showReport_(sheriff, bug)]]">
        <dropdown-input
            id="report"
            state-path="[[statePath]].report"
            on-clear="onReportClear_"
            on-input-keyup="onReportKeyup_"
            on-option-select="onReportSelect_">
        </dropdown-input>
      </iron-collapse>

      <cp-input
          id="min_revision"
          value="[[minRevision]]"
          placeholder="min revision"
          on-keyup="onMinRevisionKeyup_">
      </cp-input>

      <cp-input
          id="max_revision"
          value="[[maxRevision]]"
          placeholder="max revision"
          on-keyup="onMaxRevisionKeyup_">
      </cp-input>

      <template is="dom-if" if="[[alertGroups]]">
        <template is="dom-if" if="[[isOwner]]">
          <iron-icon
              id="edit"
              icon="editor:mode-edit">
          </iron-icon>
        </template>
        <template is="dom-if" if="[[!isOwner]]">
          <a id="documentation"
             href="#"
             target="_blank"
             title="Documentation">
            <iron-icon icon="help"></iron-icon>
          </a>
        </template>
      </template>

      <paper-toggle-button
          id="improvements"
          disabled="[[!_empty(bug.selectedOptions)]]"
          checked$="[[showingImprovements]]"
          on-change="onToggleImprovements_">
        Improvements
      </paper-toggle-button>

      <paper-toggle-button
          id="triaged"
          disabled="[[!_empty(bug.selectedOptions)]]"
          checked$="[[showingTriaged]]"
          on-change="onToggleTriaged_">
        Triaged
      </paper-toggle-button>

      <span id="summary">
        <template is="dom-if" if="[[!areAlertGroupsPlaceholders]]">
          [[summary_(alertGroups)]]
        </template>
      </span>

      <span>
        <raised-button
            id="recent_bugs"
            disabled$="[[_empty(recentlyModifiedBugs)]]"
            on-click="onTapRecentlyModifiedBugs_">
          Recent Bugs
        </raised-button>

        <paper-dialog
            opened="[[hasTriagedNew]]"
            horizontal-align="right"
            vertical-align="top"
            no-overlap
            on-iron-overlay-canceled="onCancelTriagedNew_">
          Created
          <a href="[[crbug_(triagedBugId)]]" target="_blank">
            [[triagedBugId]]
          </a>
        </paper-dialog>

        <paper-dialog
            opened="[[hasTriagedExisting]]"
            horizontal-align="right"
            vertical-align="top"
            no-overlap
            on-iron-overlay-canceled="onCancelTriagedExisting_">
          Updated
          <a href="[[crbug_(triagedBugId)]]" target="_blank">
            [[triagedBugId]]
          </a>
        </paper-dialog>

        <paper-dialog
            opened="[[hasIgnored]]"
            horizontal-align="right"
            vertical-align="top"
            no-overlap
            on-iron-overlay-canceled="onCancelIgnored_">
          Ignored [[ignoredCount]] alert[[_plural(ignoredCount)]]
        </paper-dialog>

        <paper-dialog
            opened="[[showingRecentlyModifiedBugs]]"
            horizontal-align="right"
            vertical-align="top"
            no-overlap
            on-iron-overlay-canceled="onCancelRecentlyModifiedBugs_">
          <table id="recent_bugs_table">
            <thead>
              <tr>
                <th>Bug #</th>
                <th>Summary</th>
              </tr>
            </thead>
            <template is="dom-repeat" items="[[recentlyModifiedBugs]]" as="bug" index-as="bugIndex">
              <tr>
                <td>
                  <a href="[[crbug_(bug.id)]]" target="_blank">
                    [[bug.id]]
                  </a>
                </td>
                <td>[[bug.summary]]</td>
              </tr>
            </template>
          </table>
        </paper-dialog>
      </span>

      <iron-icon
          id="close"
          icon="close"
          on-click="onClose_">
      </iron-icon>
    </div>

    <paper-progress indeterminate="[[isLoading_(isLoading, preview.isLoading)]]">
    </paper-progress>

    <template is="dom-if" if="[[!_empty(alertGroups)]]">
      <div id="triage_controls"
           anySelected$="[[!_eq(0, selectedAlertsCount)]]">
        <div id="selected_alerts_count">
          [[selectedAlertsCount]] selected
          alert[[_plural(selectedAlertsCount)]]
        </div>

        <div class="button"
            disabled$="[[_eq(0, selectedAlertsCount)]]"
            on-click="onCharts_">
          Open Chart[[_plural(selectedAlertsCount)]]
        </div>

        <span style="position: relative;">
          <div class="button"
              disabled$="[[!canTriage_(alertGroups)]]"
              on-click="onTriageNew_">
            New Bug
          </div>

          <triage-new
              state-path="[[statePath]].newBug"
              on-submit="onTriageNewSubmit_">
          </triage-new>
        </span>

        <span style="position: relative;">
          <div class="button"
              disabled$="[[!canTriage_(alertGroups)]]"
              on-click="onTriageExisting_">
            Existing Bug
          </div>

          <triage-existing
              tabindex="0"
              state-path="[[statePath]].existingBug"
              on-submit="onTriageExistingSubmit_">
          </triage-existing>
        </span>

        <div class="button"
            disabled$="[[!canTriage_(alertGroups)]]"
            on-click="onIgnore_">
          Ignore
        </div>

        <div class="button"
            disabled$="[[!canUnassignAlerts_(alertGroups)]]"
            on-click="onUnassign_">
          Unassign
        </div>
      </div>
    </template>

    <alerts-table
        state-path="[[statePath]]"
        on-selected="onSelected_"
        on-sort="onSort_"
        on-select-alert="onSelectAlert_">
    </alerts-table>

    <iron-collapse opened="[[!_empty(alertGroups)]]">
      <chart-pair
          id="preview"
          state-path="[[statePath]].preview"
          linked-state-path="[[linkedStatePath]]"
          on-dot-click="onDotClick_"
          on-line-count-change="onPreviewLineCountChange_"
          on-dot-mouseover="onDotMouseOver_">
        Select alerts using the checkboxes in the table above to preview their timeseries.
      </chart-pair>
    </iron-collapse>
  </template>
</dom-module>
<script src="/dashboard/spa/alerts-section.js"></script>
